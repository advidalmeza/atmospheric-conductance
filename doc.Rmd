---
title: "Sensitivity Analysis of Atmospheric Conductance"
author: "Alessandra Vidal Meza, Kiran Favre"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#load packages
library(tidyverse)
library(lhs)
library(sensitivity)
library(purrr)
```


**Objective**

For a given forest, you will perform a sensitivity analysis of model
predictions of conductance Consider the sensitivity of your estimate to
uncertainty in the following parameters and inputs

• height\
• kd\
• k0\
• v

Windspeeds *v* are normally distributed with a mean of 250 cm/s with a
standard deviation of 30 cm/s For vegetation height assume that height
is somewhere between 9.5 and 10.5 m (but any value in that range is
equally likely) For the kd and k0 parameters you can assume that they
are normally distributed with standard deviation of 1% of their default
values

a)  Use the Latin hypercube approach to generate parameter values for
    the 4 parameters
    
b)  Run the atmospheric conductance model for these parameters

c)  Plot conductance estimates in a way that accounts for parameter
    uncertainty 1

d)  Plot conductance estimates against each of your parameters

e)  Estimate the Partial Rank Correlation Coefficients

f)  Discuss what your results tell you about how aerodynamic
    conductance? What does it suggest about what you should focus on if
    you want to reduce uncertainty in aerodymaic conductance estimates?
    Does this tell you anything about the sensitivity of plant water use
    to climate change?
    
```{r}
#set source for function
source("src/catm.R")

#set seed to randomize
set.seed(7)

#set parameters we are interested in 
par_names = c("v", "height", "k_o", "k_d")

#number of parameters
n_par =  length(par_names)

#set number of samples we will use
n_sample = 100

#making a matrix with random samples for the 4 parameters we have
par_quant = randomLHS(n_sample, n_par)

#assigning parameter names
colnames(par_quant) = par_names

#make a df of parameters
par_df = as.data.frame(matrix(nrow=nrow(par_quant),
                            ncol=ncol(par_quant)))

#name the cols the paramters
colnames(par_df) = par_names

#to create the 1% standard deviation
pvar = 100

#normal, setting params to values given in assignment 
par_df[,"v"] = qnorm(par_quant[,"v"], mean=250, sd=30)
par_df[,"k_d"] = qnorm(par_quant[,"k_d"], mean=0.7, sd=0.7/pvar)
par_df[,"k_o"] = qnorm(par_quant[,"k_o"], mean=0.1, sd=0.1/pvar)

# uniform - setting height to 9.5-10.5 m as given in assignment
par_df[,"height"] = qunif(par_quant[,"height"], min = 9.5, max = 10.5)
```

```{r}
#lets run our model for all of the parameters generated by LHS
ca_outputs = pmap(par_df, Catm)

#turn results in to array for easy display/analysis
output_array = unlist(ca_outputs)

# put the outputs in the same df as the parameters
par_outputs <- par_df |>
  mutate(output = output_array)
```

